AWSTemplateFormatVersion: 2010-09-09
Description: >-
  Define resources for using container by ECS on Fargate.
  â–  create resources
  - ECS
    - IAM Role
  - ECR
  - VPC
  - Subnet
  - Security Group

# Metadata: 

Parameters: 
  RepositoryName:
    Type: String
    Description: "The name of the ECR Repository"
    Default: "notify-kobe-info-repository"

  ClusterName:
    Type: String
    Description: "The naem of the ECS Cluster"
    Default: "notify-kobe-info-cluster"

  TaskDefinitionFamily:
    Type: String
    Description: "The family name of the ECS task definition"
    Default: "notify-kobe-info-family-name"

  ContainerName:
    Type: String
    Description: "The name of the container in the task definition"
    Default: "notify-kobe-info-container-name"
  
  ContainerImage:
    Type: String
    Description: "The image of the container"
    Default: "notify-kobe-info-container-image"
  
  ContainerMemory:
    Type: Number
    Description: "The amount of memory (in MiB) to allocate to the container"
    Default: 512
  
  ContainerCpu:
    Type: Number
    Description: "The number of CPU units to allocate to the container"
    Default: 256

  

# Mappings: 

# Conditions: 

Resources: 
  
  ECRRepository:
    Type: "AWS::ECR::Repository"
    Properties:
      RepositoryName: !Ref RepositoryName
  
  ECSCluster:
    Type: "AWS::ECS::Cluster"
    Properties:
      ClusterName: !Ref ClusterName
  
  ECSExecutionRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service:
                - "ecs-tasks.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"
      Policies:
        - PolicyName: "ecs-execution-policy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: "Allow"
                Action:
                  - "ecr:GetDownloadUrlForLayer"
                  - "ecr:BatchGetImage"
                  - "ecr:BatchCheckLayerAvailability"
                  - "ecr:GetAuthorizationToken"
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource: "*"

  ECSTaskDefinition:
    Type: "AWS::ECS::TaskDefinition"
    Properties:
      Family: !Ref TaskDefinitionFamily
      RequiresCompatibilities: 
        - FARGATE
      NetworkMode: awsvpc
      Cpu: !Ref ContainerCpu
      Memory: !Ref ContainerMemory
      ExecutionRoleArn: !GetAtt ECSExecutionRole.Arn
      ContainerDefinitions:
        - Name: !Ref ContainerName
          Image: !Ref ContainerImage
          Essential: true
          PortMappings:
            - ContainerPort: 80
              HostPort: 80



# Outputs: